---
import AdminLayout from "@/components/admin/AdminLayout.astro";
import type { Member } from "@/types/cms";

const db = Astro.locals.runtime.env.DB;

const { results: members } = await db
  .prepare(`
    SELECT * FROM members
    ORDER BY group_type ASC, sort_order ASC, name ASC
  `)
  .all<Member>();

// Group members by type
const groupedMembers = members.reduce((acc, member) => {
  const group = member.group_type;
  if (!acc[group]) {
    acc[group] = [];
  }
  acc[group].push(member);
  return acc;
}, {} as Record<string, Member[]>);

const groupLabels: Record<string, string> = {
  vestry: 'Vestry',
  'music-team': 'Music Team',
  endowment: 'Endowment Committee',
  clergy: 'Clergy',
};
---

<AdminLayout title="Members">
  <div class="page-header">
    <h1>Members</h1>
    <a href="/admin/members/new" class="btn btn-primary">Add Member</a>
  </div>

  {Object.keys(groupedMembers).length > 0 ? (
    <div class="member-groups">
      {Object.entries(groupedMembers).map(([group, groupMembers]) => (
        <div class="member-group">
          <h2 class="group-title">{groupLabels[group] || group}</h2>
          <div class="members-table-container">
            <table class="data-table">
              <thead>
                <tr>
                  <th>Photo</th>
                  <th>Name</th>
                  <th>Title</th>
                  <th>Term</th>
                  <th>Order</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody>
                {groupMembers.map((member) => (
                  <tr>
                    <td class="photo-cell">
                      {member.image ? (
                        <img src={member.image} alt={member.name} class="member-photo" />
                      ) : (
                        <div class="no-photo">
                          <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/>
                            <circle cx="12" cy="7" r="4"/>
                          </svg>
                        </div>
                      )}
                    </td>
                    <td>{member.name}</td>
                    <td>{member.title}</td>
                    <td class="term-cell">{member.term || 'â€”'}</td>
                    <td class="order-cell">{member.sort_order}</td>
                    <td class="actions-cell">
                      <a href={`/admin/members/${member.id}`} class="btn btn-sm btn-secondary">
                        Edit
                      </a>
                    </td>
                  </tr>
                ))}
              </tbody>
            </table>
          </div>
        </div>
      ))}
    </div>
  ) : (
    <div class="empty-state">
      <svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
        <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/>
        <circle cx="9" cy="7" r="4"/>
        <path d="M23 21v-2a4 4 0 0 0-3-3.87"/>
        <path d="M16 3.13a4 4 0 0 1 0 7.75"/>
      </svg>
      <h2>No members yet</h2>
      <p>Add vestry members, clergy, music team, and endowment committee members.</p>
      <a href="/admin/members/new" class="btn btn-primary">Add First Member</a>
    </div>
  )}
</AdminLayout>

<style>
  .page-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 2rem;
  }

  .page-header h1 {
    font-size: 1.75rem;
    font-weight: 700;
    color: var(--color-text);
  }

  .member-groups {
    display: flex;
    flex-direction: column;
    gap: 2.5rem;
  }

  .group-title {
    font-size: 1.25rem;
    font-weight: 600;
    color: var(--color-primary);
    margin-bottom: 1rem;
    padding-bottom: 0.5rem;
    border-bottom: 2px solid var(--color-accent);
  }

  .members-table-container {
    overflow-x: auto;
  }

  .data-table {
    width: 100%;
    border-collapse: collapse;
    background: var(--color-surface);
    border-radius: 8px;
    overflow: hidden;
  }

  .data-table th,
  .data-table td {
    padding: 0.875rem 1rem;
    text-align: left;
    border-bottom: 1px solid var(--color-border);
  }

  .data-table th {
    background: var(--color-background);
    font-weight: 600;
    font-size: 0.8125rem;
    text-transform: uppercase;
    letter-spacing: 0.025em;
    color: var(--color-text-secondary);
  }

  .data-table tbody tr:hover {
    background: var(--color-background);
  }

  .photo-cell {
    width: 50px;
  }

  .member-photo {
    width: 40px;
    height: 40px;
    border-radius: 50%;
    object-fit: cover;
  }

  .no-photo {
    width: 40px;
    height: 40px;
    border-radius: 50%;
    background: var(--color-background);
    display: flex;
    align-items: center;
    justify-content: center;
    color: var(--color-text-secondary);
  }

  .term-cell,
  .order-cell {
    color: var(--color-text-secondary);
    font-size: 0.9375rem;
  }

  .order-cell {
    width: 70px;
    text-align: center;
  }

  .actions-cell {
    width: 100px;
  }

  .btn {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    padding: 0.625rem 1.25rem;
    border-radius: 6px;
    font-weight: 600;
    text-decoration: none;
    font-size: 0.875rem;
    transition: all 0.2s;
    cursor: pointer;
    border: none;
  }

  .btn-sm {
    padding: 0.375rem 0.75rem;
    font-size: 0.8125rem;
  }

  .btn-primary {
    background: var(--color-accent);
    color: white;
  }

  .btn-primary:hover {
    background: var(--color-primary);
  }

  .btn-secondary {
    background: var(--color-background);
    color: var(--color-text);
    border: 1px solid var(--color-border);
  }

  .btn-secondary:hover {
    background: var(--color-surface);
    color: var(--color-primary);
  }

  .empty-state {
    text-align: center;
    padding: 4rem 2rem;
    background: var(--color-surface);
    border-radius: 12px;
  }

  .empty-state svg {
    color: var(--color-text-secondary);
    margin-bottom: 1rem;
  }

  .empty-state h2 {
    font-size: 1.25rem;
    margin-bottom: 0.5rem;
    color: var(--color-text);
  }

  .empty-state p {
    color: var(--color-text-secondary);
    margin-bottom: 1.5rem;
  }
</style>
